#!/usr/bin/env ruby
require File.join ENV['HOME'],"src/fim","config.rb"
require File.join ENV['HOME'],"src/fim","flickr.rb"

index = {}
index['*'] = []
@start_time = Time.now
#JSON.parse(File.read "./exif.json").each do |t|
JSON.parse(`zsh -c "exiftool -j -fast2 -CreateDate -Keywords #{@imagedir}/**/"`).each do |t|
  @exif_time = Time.now
  img = t["SourceFile"]
  if img =~ /jpg$|jpeg$|png$/i
    date = t["CreateDate"]
    date ||= t["SourceFile"].sub(/#{@imagedir}\//,'').sub(/\//,':')
    tags = [t["Keywords"]].flatten
    tags ||= [] 
    tags.collect!{|t| t.to_s}
    tags << '_' if (tags & @q_tags).empty?
    tags.each do |t| 
      index[t.to_s] ||= [] 
      index[t.to_s] << [img,date]
      index['*'] << [img,date]
    end
  else
    puts "Not a standard image file: #{img}"
  end
end

index.each_key { |t| index[t] = index[t].sort{|a,b| a.last <=> b.last}.collect{|i| i.first}.uniq }

@index_time = Time.now

=begin
begin
  login = flickr.test.login
  flickr.photosets.getList.each do |s|
    tag =  s.title.capitalize
    photos = flickr.photosets.getPhotos(:photoset_id => s.id)["photo"].collect{|p| @flickr_ids.key(p.id.to_i)}
    puts "fim-flickr mismatch for tag #{tag}" unless index[tag] and index[tag].size == photos.size
    index[tag] = photos
  end
rescue
  puts "Failed to update flickr tags"
end
=end

File.open(@indexfile, 'w+') { |f| f.puts index.to_yaml }
@flickr_time = Time.now
#`fim-update-thumbs`
@thumb_time = Time.now
@total_time = Time.now

puts "exif:   #{@exif_time-@start_time}"
puts "index:  #{@index_time-@exif_time}"
puts "flickr: #{@flickr_time-@index_time}"
puts "thumbs: #{@thumb_time-@flickr_time}"
puts "---"
puts "total:  #{@total_time-@start_time}"
