:javascript 

  var images = [#{@images.collect{|i| '"'+i+'"'}.join(',')}];
  var current = "#{@current}";
  var size = #{@rows*@columns};
  var idx = #{@images.index(@current)};
  var first = size*Math.floor(idx/size);

  $(document).keypress(function(e) {
      switch(String.fromCharCode(e.which)) {

        case "h": move(-1); break;  
        case "j": move(#{@columns}); break;  
        case "k": move(-#{@columns}); break;  
        case "l": move(1); break;  

        case "b": move(-size); break;
        case " ": move(size); break;

        case "G": movelast(); break;
        case "g": movefirst(); break;

        case "\r": window.location.href = "/show"+current; break;

        //case "r": rotate(90); break;
        //case "R": rotate(270); break;
        case "f": rotate(180); break;

        case "c": window.location.href = "/crop"+images[idx]; break;
        case "e": $.post("/edit",{image: images[idx]}); break;
        case "p": $.get("/print/"+ images[idx]); break;

        // generic tagging
        case "t": $.get("/tag/select", function(t) { tag(t); }); break;
        case "T": $.get("/tag/select", function(t) { window.location.href = "/tag/"+t; }); break;

        // fast tagging
        // delete 
        case "1": tag("delete"); break;
        //! (shift 1)
        case "!": window.location.href = "/tag/delete"; break;
        // keep 
        case "2": tag("keep"); break;
        //@ (shift 2)
        case "@": window.location.href = "/tag/keep"; break; 
        // work
        case "3": tag("work"); break;
        //# (shift 3)
        case "#": window.location.href = "/tag/work"; break;
        // portfolio
        case "4": tag("portfolio"); break;
        //$ (shift 4)
        case "$": window.location.href = "/tag/portfolio"; break;

        // selected
        case "s": tag("selected"); break; 
        case "S": window.location.href = "/tag/selected"; break;

        // empty tags
        case "0": window.location.href = "/tag/empty"; break;
      }
  });

  $(document).ready(function() {
    makeTable();
    highlight();
    $("#info").load("/info"+current);
  });

  function highlight() {
    $("#img"+idx).removeClass("other");
    $("#img"+idx).addClass("current");
  }

  function move(offset) {
    $("#img"+idx).removeClass("current");
    $("#img"+idx).addClass("other");
    idx = idx + offset;
    if (idx < 0) { idx = 0; }
    else if (idx >= #{@images.size}) { idx = #{@images.size - 1}; }
    current = images[idx];
    $.post("current"+current, {});
    if ((idx < first)|(idx >= first+size)) { location.reload(); }
    else {
      highlight();
      $("#info").load("/info/"+current);
    }
  }

  function movefirst() {
    $.post("current"+images[0], {});
    window.location.reload();
  }

  function movelast() {
    $.post("current"+images[images.length-1], {});
    window.location.reload();
  }

  function tag(t) {
    $.post("/tag/"+current, { tag: t }, function(result) {
      if (result == "false") {
        $.post("/current/"+current,{}, function() {
          window.location.href = "/index";
        });
      }
    });
    if (t == "selected") { $("#img"+idx).toggleClass("selected"); };
  }

  function rotate(angle) {
    $.post("/rotate"+images[idx], { degrees: angle }, function(thumb) {
      var timestamp = new Date().getTime();
      $("#img"+idx).attr("src",thumb+"?"+timestamp);
    });
  }

  function makeTable() {

    $('#index').append('<table width="100%", length="100%"></table>');
    $('#index table').append('<tbody></tbody>');

    n = first;
    for(c=0;c<#{@rows};c++){
      trow = '<tr>';
      for(k=0;k<#{@columns};k++) {
        trow += '<td>';
        if (n < images.length) {
          trow += '<img src="'+images[n].replace(/images/, "thumbs").replace(/jpg/i,"png")+'", id="img'+n+'", class="other"'+'" />'
        }
        trow += '</td>'
        n = n+1;
      }
      trow += '</tr>'
      $('#index table tbody').append(trow);
    }
  }

#index
#info
