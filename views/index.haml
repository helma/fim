:javascript 

  var images = [#{@images.collect{|i| '"'+i+'"'}.join(',')}];
  var current = #{@current};
  var idx = #{@current.modulo(@rows*@columns)};

  $(document).ready(function() {
    $("#img"+idx).removeClass("other");
    $("#img"+idx).addClass("current");
    $("#info").load("/info/"+current);
  });

  function move(offset) {
    $("#img"+idx).removeClass("current");
    $("#img"+idx).addClass("other");
    current = current + offset;
    idx = idx + offset;
    if (idx >= images.length) { window.location.href = "/index/next"; }
    else if (idx < 0)  { window.location.href = "/index/prev"; }
    else {
      $("#img"+idx).removeClass("other");
      $("#img"+idx).addClass("current");
      $("#info").load("/info/"+current);
    }
  }

  function tag(t) {
    $.post("/tag/"+current, { tag: t }, function(result) {
      if (result == "false") {
        $.post("/current/"+current,{}, function() {
          window.location.href = "/index";
        });
      }
    });
    if (t == "selected") { $("#img"+idx).toggleClass("selected"); };
  }

  function rotate(angle) {
    $.post("/rotate"+images[idx], { degrees: angle }, function(thumb) {
      var timestamp = new Date().getTime();
      $("#img"+idx).attr("src",thumb+"?"+timestamp);
    });
  }

  $(document).keypress(function(e) {
      switch(String.fromCharCode(e.which)) {

        case "h": move(-1); break;  
        case "j": move(#{@columns}); break;  
        case "k": move(-#{@columns}); break;  
        case "l": move(1); break;  

        case "b": window.location.href = "/index/prev"; break;
        case " ": window.location.href = "/index/next"; break;

        case "G": window.location.href = "/index/last"; break;
        case "g": window.location.href = "/index/first"; break;

        case "\r": window.location.href = "/show/"+current; break;

        case "r": rotate(90); break;
        case "R": rotate(270); break;
        case "f": rotate(180); break;

        case "c": window.location.href = "/crop"+images[idx]; break;
        case "e": $.post("/edit",{image: images[idx]}); break;
        case "p": $.get("/print/"+ images[idx]); break;

        // generic tagging
        case "t": $.get("/tag/select", function(t) { tag(t); }); break;
        case "T": $.get("/tag/select", function(t) { window.location.href = "/tag/"+t; }); break;

        // fast tagging
        // delete 
        case "1": tag("delete"); break;
        //! (shift 1)
        case "!": window.location.href = "/tag/delete"; break;
        // keep 
        case "2": tag("keep"); break;
        //@ (shift 2)
        case "@": window.location.href = "/tag/keep"; break; 
        // work
        case "3": tag("work"); break;
        //# (shift 3)
        case "#": window.location.href = "/tag/work"; break;
        // portfolio
        case "4": tag("portfolio"); break;
        //$ (shift 4)
        case "$": window.location.href = "/tag/portfolio"; break;

        // selected
        case "s": tag("selected"); break; 
        case "S": window.location.href = "/tag/selected"; break;

        // empty tags
        case "0": window.location.href = "/tag/empty"; break;

        //case "q": window.open('','_self',''); window.close(); break;
      }
  });

%table{:width => "100%",:height => "100%"}
  - i = 0
  - @rows.times do
    %tr
      - @columns.times do
        %td{:align => "center"}
          - if @images[i]
            - if @selected.include? @images[i]
              %img{:src => Thumb.path(@images[i]), :id => "img#{i}", :class => "selected" }
            - else
              %img{:src => Thumb.path(@images[i]), :id => "img#{i}", :class => "other" }
        - i += 1

#info
